<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risolutore Cubo Rubik AI</title>
    <style>
        :root {
            --bg-color: #222;
            --text-color: white;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-yellow: #ffc107;
            --panel-bg: #333;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-color); text-align: center; margin: 0; padding: 20px; }
        h1 { margin-bottom: 10px; }
        
        .main-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; margin-top: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; }
        
        /* Sezione Video Sinistra */
        .video-section { flex: 1 1 600px; display: flex; flex-direction: column; align-items: center; }
        
        /* FIX WEBCAM SCHIACCIATA: width 100% e height auto mantiene le proporzioni originali */
        .video-box { 
            border: 4px solid #555; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            width: 100%; max-width: 640px; height: auto; display: block;
        }
        
        .tip-box {
            background: #fff3cd; color: #856404; border-left: 5px solid #ffeeba;
            padding: 15px; margin-top: 15px; border-radius: 8px; text-align: left; font-size: 0.9rem;
            max-width: 640px; width: 100%; box-sizing: border-box;
        }
        .tip-box strong { display: block; margin-bottom: 5px; font-size: 1rem; }

        /* Sezione Controlli Destra */
        .controls-section { flex: 0 1 400px; background: var(--panel-bg); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: left; display: flex; flex-direction: column; }
        
        /* Diagramma Cubo Aperto (Net) */
        .cube-net-container { text-align: center; margin-bottom: 20px; }
        .cube-net-title { font-size: 1rem; margin-bottom: 10px; color: #ccc; }
        .cube-net {
            display: grid;
            grid-template-columns: repeat(4, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 4px;
            justify-content: center;
            margin: 0 auto;
            width: fit-content;
        }
        .net-face {
            width: 50px; height: 50px;
            background: #444; border: 2px solid #222;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #777; border-radius: 4px; transition: all 0.3s ease;
        }
        .face-U { grid-column: 2; grid-row: 1; } 
        .face-L { grid-column: 1; grid-row: 2; } 
        .face-F { grid-column: 2; grid-row: 2; } 
        .face-R { grid-column: 3; grid-row: 2; } 
        .face-B { grid-column: 4; grid-row: 2; } 
        .face-D { grid-column: 2; grid-row: 3; } 

        .net-face.active {
            background: var(--accent-blue); color: white; border-color: #80bdff;
            box-shadow: 0 0 15px var(--accent-blue); transform: scale(1.1); z-index: 2;
        }
        .net-face.scanned { background: var(--accent-green); color: white; border-color: #218838; }

        /* Istruzioni Dinamiche */
        #dynamic-instructions {
            font-size: 1.1rem; margin-bottom: 20px; padding: 15px;
            background: rgba(0, 123, 255, 0.1); border-left: 4px solid var(--accent-blue); border-radius: 4px;
            min-height: 60px; display: flex; align-items: center;
        }
        #dynamic-instructions b { color: var(--accent-blue); margin-right: 5px; font-size: 1.2rem; }

        /* Bottoni */
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 20px; font-size: 18px; cursor: pointer; background: var(--accent-blue); color: white; border: none; border-radius: 8px; transition: background 0.2s; font-weight: bold; }
        button:hover { filter: brightness(110%); }
        button:active { transform: scale(0.98); }
        button.solve { background: var(--accent-green); display: none; } 
        button.undo { background: var(--accent-yellow); color: #333; display: none; } /* Tasto Annulla */
        button.reset { background: var(--accent-red); margin-top: auto; }

        /* Log e Soluzione */
        #log { background: #222; padding: 10px; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #444; }
    </style>
</head>
<body>

    <h1>üì∑ Risolutore Cubo di Rubik AI</h1>

    <div class="main-container">
        <div class="video-section">
            <img src="{{ url_for('video_feed') }}" class="video-box" alt="Flusso Video Webcam">
            
            <div class="tip-box">
                <strong>üí° Consigli:</strong>
                <ul>
                    <li>Usa la torcia del telefono se puoi.</li>
                    <li>Centra i quadratini nella griglia.</li>
                    <li>Se sbagli, usa "Annulla Ultima" invece di ricominciare tutto.</li>
                </ul>
            </div>
        </div>

        <div class="controls-section">
            <div class="cube-net-container">
                <div class="cube-net-title">Stato Scansione</div>
                <div class="cube-net">
                    <div id="net-U" class="net-face face-U active">U</div>
                    <div id="net-L" class="net-face face-L">L</div>
                    <div id="net-F" class="net-face face-F">F</div>
                    <div id="net-R" class="net-face face-R">R</div>
                    <div id="net-B" class="net-face face-B">B</div>
                    <div id="net-D" class="net-face face-D">D</div>
                </div>
            </div>

            <div id="dynamic-instructions">Inizializzazione...</div>
            
            <div class="btn-group">
                <button id="scanBtn" onclick="scanFace()">üì∏ SCANSIONA FACCIA CORRENTE</button>
                <button id="undoBtn" onclick="undoLastFace()" class="undo">‚Ü©Ô∏è ANNULLA ULTIMA FACCIA</button>
                <button id="solveBtn" onclick="solveCube()" class="solve">üß† CALCOLA SOLUZIONE</button>
                <button onclick="resetCube()" class="reset">üóëÔ∏è RESET TOTALE</button>
            </div>

            <h4>Log Operazioni:</h4>
            <div id="log">Pronto.</div>
        </div>
    </div>

    <script>
        const facesOrder = ['Up', 'Right', 'Front', 'Down', 'Left', 'Back'];
        const faceIds = {'Up': 'net-U', 'Right': 'net-R', 'Front': 'net-F', 'Down': 'net-D', 'Left': 'net-L', 'Back': 'net-B'};
        const instructions = [
            "<b>1. UP (Sopra):</b> Faccia in ALTO.",
            "<b>2. RIGHT (Destra):</b> Ruota il cubo a SINISTRA.",
            "<b>3. FRONT (Fronte):</b> Ruota il cubo a SINISTRA.",
            "<b>4. DOWN (Sotto):</b> CAPOVOLGI il cubo.",
            "<b>5. LEFT (Sinistra):</b> Ruota il cubo a SINISTRA.",
            "<b>6. BACK (Dietro):</b> Ruota il cubo a SINISTRA."
        ];

        let currentStepIndex = 0;

        window.onload = function() { updateUIForStep(0); };

        function updateUIForStep(index) {
            currentStepIndex = index;
            
            // Testo Istruzioni
            const instrDiv = document.getElementById('dynamic-instructions');
            if (index < instructions.length) {
                instrDiv.innerHTML = instructions[index];
                document.getElementById('scanBtn').style.display = 'block';
                document.getElementById('solveBtn').style.display = 'none';
            } else {
                instrDiv.innerHTML = "<b>‚úÖ Scansione Completa!</b>";
                document.getElementById('scanBtn').style.display = 'none';
                document.getElementById('solveBtn').style.display = 'block';
            }

            // Gestione Tasto Annulla (non mostrarlo se siamo all'inizio)
            if (index > 0) {
                document.getElementById('undoBtn').style.display = 'block';
            } else {
                document.getElementById('undoBtn').style.display = 'none';
            }

            // Aggiorna Diagramma Visivo
            document.querySelectorAll('.net-face').forEach(el => el.classList.remove('active'));
            if (index < facesOrder.length) {
                const currentNetId = faceIds[facesOrder[index]];
                document.getElementById(currentNetId).classList.add('active');
            }
        }

        function markFaceAsScanned(faceName) {
            const netId = faceIds[faceName];
            document.getElementById(netId).classList.remove('active');
            document.getElementById(netId).classList.add('scanned');
        }

        function unmarkFace(faceName) {
            const netId = faceIds[faceName];
            document.getElementById(netId).classList.remove('scanned');
        }

        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += "<div>" + msg + "</div>";
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function scanFace() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true; btn.innerText = "Acquisizione...";

            fetch('/scan_face', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false; btn.innerText = "üì∏ SCANSIONA FACCIA CORRENTE";
                if(data.status === 'ok') {
                    log("‚úÖ " + data.face + " presa.");
                    markFaceAsScanned(data.face);
                    updateUIForStep(data.next_index);
                } else if(data.status === 'error') {
                    log("‚ùå " + data.msg);
                }
            })
            .catch(() => { btn.disabled = false; log("‚ùå Errore Server"); });
        }

        function undoLastFace() {
            fetch('/undo_last_face', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'ok') {
                    log("‚Ü©Ô∏è Annullata: " + data.face_removed);
                    unmarkFace(data.face_removed); // Rimuovi il verde
                    updateUIForStep(data.new_index); // Torna indietro
                } else {
                    log("‚ö†Ô∏è Impossibile annullare.");
                }
            });
        }

function solveCube() {
            const btn = document.getElementById('solveBtn');
            btn.disabled = true; btn.innerHTML = "‚è≥ Elaborazione...";
            
            fetch('/solve', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false; btn.innerHTML = "üß† CALCOLA SOLUZIONE";
                if(data.status === 'solved') {
                    // Costruiamo i parametri URL con mosse E colori
                    const params = new URLSearchParams();
                    params.append('moves', data.solution);
                    
                    // Aggiungiamo i colori dei centri (es. u=Y, f=R...)
                    params.append('u', data.face_colors.U);
                    params.append('d', data.face_colors.D);
                    params.append('f', data.face_colors.F);
                    params.append('b', data.face_colors.B);
                    params.append('r', data.face_colors.R);
                    params.append('l', data.face_colors.L);

                    // Reindirizza
                    window.location.href = "/solution_view?" + params.toString();
                } else {
                    log("‚ùå Errore: " + data.msg);
                    alert("Errore: " + data.msg);
                }
            });
        }
    
        function resetCube() {
            if(!confirm("Vuoi resettare TUTTO da capo?")) return;
            fetch('/reset', { method: 'POST' }).then(() => {
                log("üóëÔ∏è Reset Totale.");
                document.querySelectorAll('.net-face').forEach(el => el.classList.remove('scanned', 'active'));
                updateUIForStep(0);
            });
        }
    </script>
</body>
</html>